---
title: "Illustration Using Global Gut Data"
author: "Huang Lin"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document: default
  pdf_document: default
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, comment = NA)

library(tidyverse)
library(microbiome)
library(ggforce)
library(limma)
library(magrittr)
library(qwraps2)
library(caret)
library(gbm)
library(pROC)
library(ggrepel)

source("ancom_bc_v2.0.R")
source("ancom_v2.1.R")
```

# 1. Data import

```{r}
# Metadata
meta_data = read_tsv("../data/global_gut_metadata.txt")
meta_data = meta_data %>% 
  transmute(sampleid = `#SampleID`, age = as.numeric(AGE), 
            age_group = ifelse(age <= 2, "Age \u2264 2 years old", "Age > 2 years old"),
            age_quant = cut(age, breaks = quantile(age, na.rm = T)),
            sex = SEX, country = COUNTRY)%>%
  arrange(sampleid)
meta_data = meta_data[-nrow(meta_data), ] # The last row is non-informative
meta_data$age_quant = recode(meta_data$age_quant, 
                             `(0.03,2]` = "Age \u2264 2", 
                             `(2,15]` = "2 < Age \u2264 15", 
                             `(15,33]` = "15 < Age \u2264 33",
                             `(33,83.2]` = "33 < Age \u2264 84")
meta_data$country = recode(meta_data$country, `GAZ:Malawi` = "MA", 
                           `GAZ:United States of America` = "US", `GAZ:Venezuela` = "VEN")
meta_data$country = factor(meta_data$country, levels = c("MA", "US", "VEN"))
meta_data$sex = factor(meta_data$sex, levels = c("female", "male"))
meta_data$age_group = factor(meta_data$age_group, 
                             levels = c("Age \u2264 2 years old", "Age > 2 years old"))
rownames(meta_data) = meta_data$sampleid # MANCOM-BC requires an id column

# Taxonomy
tax = read_tsv("../data/global_gut_taxonomy.txt") %>% arrange(OTU_ID)
otu_id = tax$OTU_ID
tax = data.frame(tax[, -1], row.names = otu_id)
tax = apply(tax, 2, function(x) sapply(x, function(y) strsplit(y, "__")[[1]][2]))
tax = as.matrix(tax)

# OTU table
otu_table = read_tsv("../data/global_gut_otu.txt")
otu_table = otu_table[, -ncol(otu_table)] # The last column is taxonomy
otu_id = otu_table$OTU_ID
otu_table = data.frame(otu_table[, -1], check.names = FALSE, row.names = otu_id)
otu_table = as.matrix(otu_table)

# OTU data
otu_data = phyloseq(otu_table(otu_table, taxa_are_rows = TRUE), 
                    sample_data(meta_data), tax_table(tax))
# Subset samples
otu_data = subset_samples(otu_data, country %in% c("MA", "US"))

# Aggregate to genus level
genus_data = aggregate_taxa(otu_data, "Genus")
# Subset samples
genus_data1 = subset_samples(genus_data, age <= 2)
genus_data2 = subset_samples(genus_data, age > 2)
# Output data
write_tsv(data.frame(abundances(genus_data1), check.names = FALSE) %>%
            rownames_to_column("genus"), 
          path = "../intermediates/genus_table1.txt")
write_tsv(meta(genus_data1), path = "../intermediates/meta1.txt")
tax1 = data.frame(tax_table(genus_data1)@.Data, check.names = FALSE)
tax1 = tax1 %>% rownames_to_column("Feature ID") %>%
  unite(col = "Taxon", Kingdom:Genus, sep = ";") %>%
  dplyr::select(-unique)
write_tsv(tax1, path = "../intermediates/tax1.txt")
write_tsv(data.frame(abundances(genus_data2), check.names = FALSE) %>%
            rownames_to_column("genus"), 
          path = "../intermediates/genus_table2.txt")
write_tsv(meta(genus_data2), path = "../intermediates/meta2.txt")
tax2 = data.frame(tax_table(genus_data2)@.Data, check.names = FALSE)
tax2 = tax2 %>% rownames_to_column("Feature ID") %>%
  unite(col = "Taxon", Kingdom:Genus, sep = ";") %>%
  dplyr::select(-unique)
write_tsv(tax2, path = "../intermediates/tax2.txt")
```

# 2. Data summary

```{r, results = "asis"}
options(qwraps2_markup = "markdown")
summary_template =
  list("Age" =
       list("min" = ~ min(.data$age, na.rm = T),
            "max" = ~ max(.data$age, na.rm = T),
            "mean (sd)" = ~ qwraps2::mean_sd(.data$age, na_rm = T, show_n = "never")),
       "Gender" =
       list("F" = ~ n_perc0(.data$sex == "female", na_rm = T),
            "M" = ~ n_perc0(.data$sex == "male", na_rm = T),
            "NA" = ~ n_perc0(is.na(.data$sex))),
       "Country" =
       list("MA" = ~ n_perc0(.data$country == "MA", na_rm = T),
            "US" = ~ n_perc0(.data$country == "US", na_rm = T),
            "VEN" = ~ n_perc0(.data$country == "VEN", na_rm = T),
            "NA" = ~ n_perc0(is.na(.data$country)))
       )
gut_summary = summary_table(meta_data %>% filter(!is.na(age_group)) %>% 
                              dplyr::group_by(age_group), summary_template)
gut_summary
```

1. The number of OTUs: `r ntaxa(otu_data)`.

2. The number of genera: `r ntaxa(genus_data)`.

    + The number of genera for age <= 2: `r ntaxa(genus_data1)`.
    
    + The number of genera for age > 2: `r ntaxa(genus_data2)`.

# 3. Compare ANCOM-BC, ANCOM, and DR

## 3.1 Age <= 2

### 3.11 ANCOM-BC

```{r}
# Run ANCOM-BC
feature_table = abundances(genus_data1); meta_data = meta(genus_data1)
sampleid = "sampleid"; adj_formula = "country"; p_adj_method = "holm"
zero_cut = 0.90; lib_cut = 1000; struc_zero = TRUE; neg_lb = TRUE; group = "country"
tol = 1e-5; max_iter = 100; conserve = TRUE; alpha = 0.05; per_num = 1000
global = FALSE; direct = FALSE; dunnett = FALSE; pattern = NULL

out = ANCOM_BC(feature_table, meta_data, sampleid, adj_formula, p_adj_method, 
               zero_cut, lib_cut, struc_zero, neg_lb, group, 
               tol, max_iter, conserve, alpha, per_num, 
               global, direct, dunnett, pattern)
res = out$res
res_ancom_bc = data.frame(res$diff_abn) %>% rownames_to_column("genus") %>%
  transmute(genus, ancom_bc = countryUS * 1)
```

### 3.12 ANCOM

```{r}
# Data preprocessing
feature_table = abundances(genus_data1); meta_data = meta(genus_data1)
sample_var = "sampleid"; group_var = "country"
out_cut = 0.05; zero_cut = 0.90; lib_cut = 1000; neg_lb = TRUE
prepro = feature_table_pre_process(feature_table, meta_data, sample_var, group_var, 
                                   out_cut, zero_cut, lib_cut, neg_lb)
feature_table = prepro$feature_table # Preprocessed feature table
meta_data = prepro$meta_data # Preprocessed metadata
struc_zero = prepro$structure_zeros # Structural zero info

# Run ANCOM
main_var = "country"; p_adj_method = "holm"; alpha = 0.05
adj_formula = NULL; rand_formula = NULL
out = ANCOM(feature_table, meta_data, struc_zero, main_var, p_adj_method, 
            alpha, adj_formula, rand_formula)
res_ancom = data.frame(out$out) %>% transmute(genus = taxa_id, ancom = detected_0.7 * 1)
```

### 3.13 DR

```{r}
dat_dr = read_tsv("../data/dr1/differentials.tsv")
dat_dr = dat_dr %>% transmute(genus = featureid, dr = `country[T.US]`)
res_dr1 = dat_dr %>% top_n(n = 25, wt = dr)
res_dr2 = dat_dr %>% top_n(n = -25, wt = dr)
res_dr = rbind(res_dr1, res_dr2) %>% mutate(dr = 1)
```

### 3.14 Venn diagram

```{r}
# Tabulation
genus = taxa(genus_data1)
sig_taxa = data.frame(genus) %>% left_join(res_ancom_bc, by = "genus") %>% 
  left_join(res_ancom, by = "genus") %>% left_join(res_dr, by = "genus") %>%
  dplyr::select(-genus)
sig_taxa = as.matrix(sig_taxa)
sig_taxa[is.na(sig_taxa)] = 0
rownames(sig_taxa) = genus
venn_below2 = vennCounts(sig_taxa)

vennDiagram(venn_below2, circle.col = c("red", "blue", "green3"), 
            names = c("ANCOM-BC", "ANCOM", "DR"))
```

## 3.2 Age > 2

### 3.21 ANCOM-BC

```{r}
# Run ANCOM-BC
feature_table = abundances(genus_data2); meta_data = meta(genus_data2)
sampleid = "sampleid"; adj_formula = "country"; p_adj_method = "holm"
zero_cut = 0.90; lib_cut = 1000; struc_zero = TRUE; neg_lb = TRUE; group = "country"
tol = 1e-5; max_iter = 100; conserve = TRUE; alpha = 0.05; per_num = 1000
global = FALSE; direct = FALSE; dunnett = FALSE; pattern = NULL

out = ANCOM_BC(feature_table, meta_data, sampleid, adj_formula, p_adj_method, 
               zero_cut, lib_cut, struc_zero, neg_lb, group, 
               tol, max_iter, conserve, alpha, per_num, 
               global, direct, dunnett, pattern)
res = out$res
res_ancom_bc = data.frame(res$diff_abn) %>% rownames_to_column("genus") %>%
  transmute(genus, ancom_bc = countryUS * 1)
```

### 3.22 ANCOM

```{r}
# Data preprocessing
feature_table = abundances(genus_data2); meta_data = meta(genus_data2)
sample_var = "sampleid"; group_var = "country"
out_cut = 0.05; zero_cut = 0.90; lib_cut = 1000; neg_lb = TRUE
prepro = feature_table_pre_process(feature_table, meta_data, sample_var, group_var, 
                                   out_cut, zero_cut, lib_cut, neg_lb)
feature_table = prepro$feature_table # Preprocessed feature table
meta_data = prepro$meta_data # Preprocessed metadata
struc_zero = prepro$structure_zeros # Structural zero info

# Run ANCOM
main_var = "country"; p_adj_method = "holm"; alpha = 0.05
adj_formula = NULL; rand_formula = NULL
out = ANCOM(feature_table, meta_data, struc_zero, main_var, p_adj_method, 
            alpha, adj_formula, rand_formula)
res_ancom = data.frame(out$out) %>% transmute(genus = taxa_id, ancom = detected_0.7 * 1)
```

### 3.23 DR

```{r}
dat_dr = read_tsv("../data/dr2/differentials.tsv")
dat_dr = dat_dr %>% transmute(genus = featureid, dr = `country[T.US]`)
res_dr1 = dat_dr %>% top_n(n = 25, wt = dr)
res_dr2 = dat_dr %>% top_n(n = -25, wt = dr)
res_dr = rbind(res_dr1, res_dr2) %>% mutate(dr = 1)
```

### 3.24 Venn diagram

```{r}
# Tabulation
genus = taxa(genus_data2)
sig_taxa = data.frame(genus) %>% left_join(res_ancom_bc, by = "genus") %>% 
  left_join(res_ancom, by = "genus") %>% left_join(res_dr, by = "genus") %>%
  dplyr::select(-genus)
sig_taxa = as.matrix(sig_taxa)
sig_taxa[is.na(sig_taxa)] = 0
rownames(sig_taxa) = genus
venn_above2 = vennCounts(sig_taxa)

vennDiagram(venn_above2, circle.col = c("red", "blue", "green3"), 
            names = c("ANCOM-BC", "ANCOM", "DR"))
```

## 3.3 Venn diagram

```{r}
class(venn_below2) = "matrix"; class(venn_above2) = "matrix"
df_venn = data.frame(x = c(0, 0.866, -0.866),
                     y = c(1, -0.5, -0.5),
                     labels = c("ANCOM-BC", "DR", "ANCOM"))

df_below2 = as.data.frame(venn_below2)%>%
  mutate(x = c(-2, 1.2, -1.2, 0, 0, 0.8, -0.8, 0),
         y = c(2, -0.6, -0.6, -1, 1.2, 0.5, 0.5, 0))
df_above2 = as.data.frame(venn_above2)%>%
  mutate(x = c(-2, 1.2, -1.2, 0, 0, 0.8, -0.8, 0),
         y = c(2, -0.6, -0.6, -1, 1.2, 0.5, 0.5, 0))

df_venn = rbind(data.frame(df_venn, compare = "Age \u2264 2 years old"), 
                data.frame(df_venn, compare = "Age > 2 years old"))
df_venn$labels = factor(df_venn$labels, levels = c("ANCOM-BC", "ANCOM", "DR"))
df_vdc = rbind(data.frame(df_below2, compare = "Age \u2264 2 years old"),
               data.frame(df_above2, compare = "Age > 2 years old"))%>%
  transmute(x, y, label = Counts, compare)

p = ggplot(df_venn) +
  geom_circle(aes(x0 = x, y0 = y, r = 1.5, fill = labels), alpha = 0.5, size = 1, colour = 'grey') +
  coord_fixed() + facet_wrap(.~compare, nrow = 1)+
  labs(x = NULL, y = NULL, fill = NULL) +
  geom_text(data = df_vdc, aes(x, y, label=label), inherit.aes=FALSE, size = 5)+
  theme_bw()+
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        strip.background = element_rect(fill="white"),
        axis.text = element_blank(),
        axis.ticks = element_blank())
p
ggsave("../figures/gut_venn.jpeg", height = 5, width = 6.25, units = 'in', dpi = 300)
ggsave("../figures/gut_venn.pdf", height = 5, width = 6.25, units = 'in')
```

# 4. Gneiss

## 4.1 Age <= 2

```{r}
gneiss_coef = read_csv("../data/gneiss1/coefficients.csv") %>%
  transmute(balance = X1, country = `country[T.US]`) %>% 
  slice(1:20)
gneiss_p = read_csv("../data/gneiss1/fdr-corrected-pvalues.csv") %>%
  transmute(balance = X1,
            country = ifelse(`country[T.US]` < 0.05, 1, 0)) %>% 
  slice(1:20)

for (i in 1:20) {
  if (gneiss_p$country[i] == 0) gneiss_coef$country[i] = 0
}

dat_fig1 = gneiss_coef %>% filter(country != 0) %>%
  mutate(balance = factor(balance, levels = factor(balance)),
         group = ifelse(country > 0, "g1", "g2"),
         age_group = "Age \u2264 2 years old")
```

## 4.2 Age > 2

```{r}
gneiss_coef = read_csv("../data/gneiss2/coefficients.csv") %>%
  transmute(balance = X1, country = `country[T.US]`) %>% 
  slice(1:20)
gneiss_p = read_csv("../data/gneiss2/fdr-corrected-pvalues.csv") %>%
  transmute(balance = X1,
            country = ifelse(`country[T.US]` < 0.05, 1, 0)) %>% 
  slice(1:20)

for (i in 1:20) {
  if (gneiss_p$country[i] == 0) gneiss_coef$country[i] = 0
}

dat_fig2 = gneiss_coef %>% filter(country != 0) %>%
  mutate(balance = factor(balance, levels = factor(balance)),
         group = ifelse(country > 0, "g1", "g2"),
         age_group = "Age > 2 years old")
```

## 4.3 Heatmap

```{r}
dat_fig = rbind(dat_fig1, dat_fig2)
dat_fig = dat_fig %>% group_by(age_group) %>% arrange(desc(country)) %>%
  ungroup() %>% arrange(age_group, desc(country)) %>% 
  mutate(order = row_number(),
         age_group = factor(dat_fig$age_group, 
                            levels = c("Age \u2264 2 years old", "Age > 2 years old")))

p = ggplot(data = dat_fig, aes(x = order, y = country, fill = group, color = group)) + 
  geom_bar(stat = "identity", width = 0.7, position = position_dodge(width = 0.4)) +
  labs(x = "Balance", y = "Coefficients (US - MA)") +
  facet_wrap(~ age_group, scales = "free") +
  theme_bw() + 
  # Add categories to axis
  scale_x_continuous(breaks = dat_fig$order, labels = dat_fig$balance, expand = c(0, 0)) +
  theme(legend.position = "none",
        panel.grid.minor.y = element_blank(),
        axis.text.x = element_text(angle = 60, hjust = 1),
        strip.background = element_rect(fill="white"))
p
ggsave("../figures/gut_gneiss.jpeg", height = 5, width = 6.25, units = 'in', dpi = 300)
ggsave("../figures/gut_gneiss.pdf", height = 5, width = 6.25, units = 'in')
```

# 5. Metadata prediction

```{r}
# Machine learning workflow
ml_flow = function(data, outcome){
  taxa_id = taxa(data)
  dat0 = data.frame(t(abundances(data)), check.names = FALSE) %>%
    rownames_to_column("sampleid") %>% left_join(meta(data), by = "sampleid")
  
  predictor = dat0 %>% dplyr::select(taxa_id)
  y = unlist(dat0 %>% dplyr::select(outcome), use.names = FALSE)
  # Data preprocess
  # Discard near zero-variance predictors
  nzv = nearZeroVar(predictor)
  predictor_nzv = predictor[, -nzv]
  # Transformations, centering and scaling, impute missing values
  trans = preProcess(predictor_nzv, method = c("BoxCox", "center", "scale", "knnImpute"))
  predictor_trans = predict(trans, predictor_nzv)
  
  dat1 = data.frame(y, predictor_trans, check.names = FALSE)
  pred_var = colnames(dat1)[-1]
  
  # Wrapper functions for performance measures
  fiveStats = function(...) c(twoClassSummary(...), defaultSummary(...))
  ctrl = trainControl(method = "cv",
                      number = 10,
                      classProbs = TRUE,
                      summaryFunction = fiveStats,
                      verboseIter = FALSE,
                      savePredictions = TRUE)
  # Generate training and test data sets
  set.seed(1234)
  in_train = createDataPartition(dat1$y, p = 0.75, list = FALSE)
  dat_train = dat1[in_train,]
  dat_test = dat1[-in_train,]
  
  # Function to save ROC data for plotting
  make_roc_dat = function(fitROC){
    fit_roc_dat = data.frame(FPR = sort(1 - fitROC$specificities), 
                             TPR = sort(fitROC$sensitivities))
    return(fit_roc_dat)
  }
  
  # PLS
  set.seed(1234)
  pls_fit = train(y ~ ., data = dat_train, method = "pls", trControl = ctrl,
                  tuneLength = 10, metric = "ROC", verbose = FALSE)
  # Test set evaluation
  eval = data.frame(y = dat_test$y, yhat = predict(pls_fit, newdata = dat_test),
                    pred = predict(pls_fit, newdata = dat_test, type = "prob")[, 2])
  plsROC = roc(eval$y, eval$pred, levels = levels(dat1$y))
  pls_roc_dat = make_roc_dat(plsROC) %>% mutate(label = "PLS")
  # Variable importance
  var_imp = varImp(pls_fit)$importance
  pls_imp_dat = var_imp %>% rownames_to_column("feature") %>% 
    transmute(feature = feature, score = Overall, model = "PLS") %>% 
    top_n(n = 10, wt = score)
  
  # SVM
  set.seed(1234)
  svm_fit = train(y ~ ., data = dat_train, method = "svmRadial", trControl = ctrl,
                  tuneLength = 10, metric = "ROC", verbose = FALSE)
  # Test set evaluation
  eval = data.frame(y = dat_test$y, yhat = predict(svm_fit, newdata = dat_test),
                    pred = predict(svm_fit, newdata = dat_test, type = "prob")[, 2])
  svmROC = roc(eval$y, eval$pred, levels = levels(dat1$y))
  svm_roc_dat = make_roc_dat(svmROC) %>% mutate(label = "SVM")
  # Variable importance
  var_imp = varImp(svm_fit)$importance
  svm_imp_dat = var_imp %>% rownames_to_column("feature") %>% 
    transmute(feature = feature, score = US, model = "SVM") %>% 
    top_n(n = 10, wt = score)
  
  # KNN
  set.seed(1234)
  knn_fit = train(y ~ ., data = dat_train, method = "knn", trControl = ctrl,
                  tuneLength = 10, metric = "ROC")
  # Test set evaluation
  eval = data.frame(y = dat_test$y, yhat = predict(knn_fit, newdata = dat_test),
                    pred = predict(knn_fit, newdata = dat_test, type = "prob")[, 2])
  knnROC = roc(eval$y, eval$pred, levels = levels(dat1$y))
  knn_roc_dat = make_roc_dat(knnROC) %>% mutate(label = "KNN")
  # Variable importance
  var_imp = varImp(knn_fit)$importance
  knn_imp_dat = var_imp %>% rownames_to_column("feature") %>% 
    transmute(feature = feature, score = US, model = "KNN") %>% 
    top_n(n = 10, wt = score)
  
  # RF
  set.seed(1234)
  rf_fit = train(y ~ ., data = dat_train, method = "rf", trControl = ctrl,
                 ntree = 500, tuneLength = 10, metric = "ROC", verbose = FALSE)
  # Test set evaluation
  eval = data.frame(y = dat_test$y, yhat = predict(rf_fit, newdata = dat_test),
                    pred = predict(rf_fit, newdata = dat_test, type = "prob")[, 2])
  rfROC = roc(eval$y, eval$pred, levels = levels(dat1$y))
  rf_roc_dat = make_roc_dat(rfROC) %>% mutate(label = "RF")
  # Variable importance
  var_imp = varImp(rf_fit)$importance
  rf_imp_dat = var_imp %>% rownames_to_column("feature") %>% 
    transmute(feature = feature, score = Overall, model = "RF") %>% 
    top_n(n = 10, wt = score)
  
  # GBM
  set.seed(1234)
  gbm_fit = train(y ~ ., data = dat_train, method = "gbm", trControl = ctrl,
                  tuneLength = 10, metric = "ROC", verbose = FALSE)
  # Test set evaluation
  eval = data.frame(y = dat_test$y, yhat = predict(gbm_fit, newdata = dat_test),
                    pred = predict(gbm_fit, newdata = dat_test, type = "prob")[, 2])
  gbmROC = roc(eval$y, eval$pred, levels = levels(dat1$y))
  gbm_roc_dat = make_roc_dat(gbmROC) %>% mutate(label = "GBM")
  # Variable importance
  var_imp = varImp(gbm_fit)$importance
  gbm_imp_dat = var_imp %>% rownames_to_column("feature") %>% 
    transmute(feature = feature, score = Overall, model = "GBM") %>% 
    top_n(n = 10, wt = score)

  # Data for top 10 important variables
  imp_dat = Reduce("rbind", list(pls_imp_dat, svm_imp_dat, knn_imp_dat, rf_imp_dat, gbm_imp_dat))
  imp_dat = imp_dat %>% group_by(feature) %>%
    summarise(times = length(model), ave_imp = mean(score, na.rm = TRUE))%>%
    top_n(n = 10, wt = ave_imp)
  
  # Data for ROC plot
  roc_dat = Reduce("rbind", list(pls_roc_dat, svm_roc_dat, knn_roc_dat, rf_roc_dat, gbm_roc_dat))
  
  return(list(imp_dat = imp_dat, roc_dat = roc_dat))
}
```

## 5.1 Age <= 2

```{r}
data = genus_data1; outcome = "country"
res = ml_flow(data, outcome)

imp_dat1 = res$imp_dat
roc_dat1 = res$roc_dat
imp_dat1$feature[2] = strsplit(imp_dat1$feature[2], "_")[[1]][6]
```

## 5.2 Age > 2

```{r}
data = genus_data2; outcome = "country"
res = ml_flow(data, outcome)

imp_dat2 = res$imp_dat
roc_dat2 = res$roc_dat
imp_dat2$feature[3] = strsplit(imp_dat2$feature[3], "_")[[1]][6]
imp_dat2$feature[4] = strsplit(imp_dat2$feature[4], "_")[[1]][6]
```

## 5.3 Making plot

```{r}
imp_dat1 = imp_dat1 %>% mutate(age_group = "Age \u2264 2 years old")
roc_dat1 = roc_dat1 %>% mutate(age_group = "Age \u2264 2 years old")
imp_dat2 = imp_dat2 %>% mutate(age_group = "Age > 2 years old")
roc_dat2 = roc_dat2 %>% mutate(age_group = "Age > 2 years old")

imp_dat = rbind(imp_dat1, imp_dat2)
imp_dat$age_group = factor(imp_dat$age_group, 
                           levels = c("Age \u2264 2 years old", "Age > 2 years old"))
roc_dat = rbind(roc_dat1, roc_dat2)
roc_dat$age_group = factor(roc_dat$age_group, 
                           levels = c("Age \u2264 2 years old", "Age > 2 years old"))

p1 = ggplot(data = imp_dat, aes(x = times, y = ave_imp)) +
  scale_x_continuous(breaks = 1:max(imp_dat$times),
                     limits = c(0, (max(imp_dat$times) + 1))) +
  scale_y_continuous(limits = c(min(imp_dat$ave_imp) - 5, max(imp_dat$ave_imp) + 5)) +
  geom_point(aes(size = ave_imp, col = ave_imp), alpha = 0.5) +
  scale_color_gradient2(low = "#0000FF", mid = "#C3D7A4", high ="#FF0000", 
                        midpoint = median(imp_dat$ave_imp), space = "rgb")+
  scale_size_continuous(range = c(1, 20)) +
  facet_grid(.~ age_group, scales = "free") +
  geom_label_repel(aes(label = feature),
                   box.padding   = 0.35, 
                   point.padding = 0.5,
                   segment.color = 'grey50')+
  labs(x = "# of Models Presented", y = "Average Importance Score")+
  theme_bw() +
  theme(legend.position = "none",
        strip.background = element_rect(fill="white"))
print(p1)
ggsave("../figures/gut_imp_var.jpeg", height = 5, width = 6.25, units = 'in', dpi = 300)
ggsave("../figures/gut_imp_var.pdf", height = 5, width = 6.25, units = 'in')

cat('\n\n')

p2 = ggplot(data = roc_dat, aes(x = FPR, y = TPR, color = label)) +
    geom_line(size = 1) +
    scale_color_discrete(name = NULL) +
    geom_abline(color = "black", slope = 1, intercept = 0, linetype = "dashed") +
    facet_grid(.~ age_group, scales = "free") +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5),
          strip.background = element_rect(fill="white"))
print(p2)
ggsave("../figures/gut_roc.jpeg", height = 5, width = 6.25, units = 'in', dpi = 300)
ggsave("../figures/gut_roc.pdf", height = 5, width = 6.25, units = 'in')
```

# Session information

```{r, message = FALSE, warning = FALSE, comment = NA}
sessionInfo()
devtools::session_info()
```









